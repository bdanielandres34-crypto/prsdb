<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administración</title>
  <link rel="stylesheet" href="admin.css" />
</head>
<body>
  <header>
    <h1>🛒 Panel de Administración</h1>
    <button id="logoutBtn">Cerrar sesión</button>
  </header>

  <main>
    <!-- Agregar producto -->
    <section id="agregar">
      <h2>Agregar producto</h2>
      <form id="addProductForm">
        <input type="text" name="name" placeholder="Nombre del producto" required>
        <input type="number" name="price" placeholder="Precio" required>
        <input type="text" name="image_url" placeholder="URL de la imagen">
        <select name="category" required>
          <option value="">Seleccionar categoría</option>
          <option value="lacteos">Lácteos</option>
          <option value="despensa">Despensa</option>
          <option value="aseo_personal">Aseo Personal</option>
          <option value="aseo_hogar">Aseo Hogar</option>
          <option value="carnes_frias">Carnes Frías</option>
        </select>
        <button type="submit">Agregar</button>
      </form>
    </section>

    <!-- Productos actuales -->
    <section id="productos">
      <h2>Productos actuales</h2>
      <div id="listaProductos"></div>
    </section>
  </main>

  <script>
    const logoutBtn = document.getElementById('logoutBtn');
    const addForm = document.getElementById('addProductForm');
    const listaProductos = document.getElementById('listaProductos');

    // Cerrar sesión
    logoutBtn.addEventListener('click', () => {
      window.location.href = '/logout';
    });

    // Cargar todos los productos
    async function cargarProductos() {
      try {
        const res = await fetch('/productos/todos'); // endpoint correcto
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const productos = await res.json();
        mostrarProductos(productos);
      } catch (err) {
        console.error('Error cargando productos:', err);
        listaProductos.innerHTML = '<p style="color:red;">No se pudieron cargar los productos. Revisa consola.</p>';
      }
    }

    // Mostrar productos
    function mostrarProductos(productos) {
      if (!productos || productos.length === 0) {
        listaProductos.innerHTML = '<p>No hay productos registrados.</p>';
        return;
      }

      listaProductos.innerHTML = ''; // limpiar contenedor

      productos.forEach(p => {
        const div = document.createElement('div');
        div.classList.add('producto');

        div.innerHTML = `
          <img src="${p.image_url || 'https://via.placeholder.com/100'}" alt="${p.name}">
          <div>
            <h3>${p.name}</h3>
            <p>💲 ${p.price}</p>
            <p><b>Categoría:</b> ${p.category}</p>
          </div>
          <button class="eliminar">🗑 Eliminar</button>
        `;

        // Botón eliminar
        const btnEliminar = div.querySelector('.eliminar');
        btnEliminar.addEventListener('click', async () => {
          if (!confirm(`¿Eliminar producto "${p.name}"?`)) return;
          try {
            const res = await fetch('/delete-product', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: p.id })
            });
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            alert(`Producto "${p.name}" eliminado ✅`);
            cargarProductos(); // recargar lista
          } catch (err) {
            console.error('Error eliminando producto:', err);
            alert('Error eliminando producto. Revisa consola.');
          }
        });

        listaProductos.appendChild(div);
      });
    }

    // Agregar producto
    addForm.addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(addForm);
      const producto = {
        name: formData.get('name'),
        price: parseFloat(formData.get('price')),
        image_url: formData.get('image_url'),
        category: formData.get('category')
      };

      try {
        const res = await fetch('/add-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(producto)
        });
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        alert(`Producto "${producto.name}" agregado ✅`);
        addForm.reset();
        cargarProductos(); // recargar lista
      } catch (err) {
        console.error('Error agregando producto:', err);
        alert('Error agregando producto. Revisa consola.');
      }
    });

    // Iniciar
    cargarProductos();
  </script>
</body>
</html>
